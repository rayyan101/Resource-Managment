<?php
/**
 * Main Functions.
 *
 * @package pong-space-customization
 */
if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly.
}

if (!class_exists('RM_Main')) {

    /**
     * Class RM_Main.
     */

    class RM_Main {
        public function __construct() {
            add_filter('parent_file', [$this, 'fix_admin_parent_file']);
            add_action( 'wp_ajax_assign_project', [$this, 'assign_project'] );
            add_action('wp_ajax_rm_unassign_resource' , [ $this, 'rm_unassign_resource' ]);

            add_action('wp_ajax_rm_resource_data_searching' , [ $this, 'rm_resource_data_searching' ]);
	
        }

        /**
         * activate current post type menu
         * */
        public function fix_admin_parent_file($parent_file){
            global $submenu_file, $current_screen;
            // Set correct active/current menu and submenu in the WordPress Admin menu for the "example_cpt" Add-New/Edit/List

            if($current_screen->post_type == 'project') {
                $submenu_file = 'edit.php?post_type=project';
                $parent_file = 'resource_manager';
            }
            if($current_screen->post_type == 'client') {
                $submenu_file = 'edit.php?post_type=client';
                $parent_file = 'resource_manager';
            }
            if($current_screen->post_type == 'resource') {
                $submenu_file = 'edit.php?post_type=resource';
                $parent_file = 'resource_manager';
            }
            return $parent_file;
        }

        /**
         * get data from cpt
         **/
        public static function get_cpt_data($post_type) {
             $args = array(
                    'posts_per_page'   => -1,
                    'post_type'        => $post_type,
                );
             $the_query = new WP_Query( $args );
             $all_posts=[];
                while ( $the_query->have_posts() ) {
                     $the_query->the_post();
                    $id = get_the_ID();
                    $title = get_the_title();
                    $all_posts[$id] = $title;
                }
                return $all_posts;
        }

        /**
         * Assign a project to resource
         * */
        public function assign_project() {

            if(!$this->empty_element_exists($_POST)){
                $resource_id = $this->rm_validate_input($_POST['resource']);
                $project_id = $this->rm_validate_input($_POST['project']);
                $allocation = $this->rm_validate_input($_POST['allocation']);
                $resource_name = get_the_title($resource_id);
                $project_name = get_the_title($project_id);

                

                global $wpdb;
                $projects_resources    = $wpdb->prefix.'projects_resources';
                $projects_resources_result = $wpdb->get_results( " SELECT * FROM $projects_resources WHERE resource_id = $resource_id and project_id = $project_id and status = 1" ); 
                $projects_resources_id = $projects_resources_result[0]->ID;
                $project_allocation = $projects_resources_result[0]->allocation;
                $project_status = $projects_resources_result[0]->status;

                $resources_allocation    = $wpdb->prefix.'resources_allocation';
                $resources_allocation_result = $wpdb->get_results( " SELECT * FROM $resources_allocation WHERE resource_id = $resource_id" );
                $resources_allocation_id = $resources_allocation_result[0]->ID;
                $resource_allocation = $resources_allocation_result[0]->allocation;

                if(!$projects_resources_result){

                    $insert_record = $wpdb->insert(
                        $projects_resources, array(
                            'project_id'        => $project_id,
                            'project_name'      => $project_name,
                            'resource_id'       => $resource_id,
                            'resource_name'     => $resource_name,
                            'allocation'        => $allocation,
                            'status'            => 1,
                        ), 
                    );

                    $updated_allocation = $resource_allocation + $allocation ;

                    $insert_record = $wpdb->update(
                        $resources_allocation, array(
                            'allocation'        => $updated_allocation,
                        ), array( 
                            'ID' => $resources_allocation_id 
                        )
                    );

                }
               
            
                if ($insert_record) {
                    $response['message'] = "Project successfully assigned"; 
                    $response['status'] = true; 
                }
                else{
                    $response['message'] = "Error inserting into database"; 
                    $response['status'] = false; 
                }
            }
            else{
                $response['message'] = "One or more field is required"; 
                $response['status'] = false; 
            }
            // print_r($resource_id);
            return $this->response_json($response);
        }

        /**
         * Parse string to json on ajax call
         * */
        public function response_json($data) {
            header('Content-Type: application/json');
            echo json_encode($data);
            wp_die();
        }
        /**
         * Validate variable on form submission
         * */
        public function rm_validate_input($input) {
            $input = trim($input);
            $input = stripslashes($input);
            $input = htmlspecialchars($input);
            return $input;
        }

        /**
         * Check if any element is empty in array
         * */
        public function empty_element_exists($arr) {
          return array_search("", $arr) !== false;
        }

        /**
         * Check if any element is empty in array
         * */
        public function rm_resource_data_searching() {
            $resource_name = $_REQUEST['resource_name'];
			$project_name = $_REQUEST['project_name'];
            $availability = $_REQUEST['availability'];
            
            
            if($availability=="checked"){
                global $wpdb;



                $resources_allocation    = $wpdb->prefix.'resources_allocation';

                $quary = "SELECT * FROM $resources_allocation where resource_name = '{$resource_name}' and allocation < 100"; 
                $resources_allocation_results = $wpdb->get_results($quary); 

                // print_r($resources_allocation_results); exit;

                if(!$projects_resources_results) {
                    $quary = "SELECT * FROM $resources_allocation where allocation < 100"; 
                    $resources_allocation_results = $wpdb->get_results($quary); 

                }
                

                
                
                foreach($resources_allocation_results as $key => $resources_allocation_result){

                    $resource_id = $resources_allocation_result->resource_id;
                    // $resourse_name = $resources_allocation_result->resource_name;
                    // $project_id = $resources_allocation_result->project_id;
                    // $project_name = $resources_allocation_result->project_name;
                    $allocation = $resources_allocation_result->allocation;
                    $total_allocation = 100 - $allocation;
                    $resource_name = get_the_title($resource_id);
                    $response['table'] .= "
                    
                    <tr>
                        <td> {$resource_id} </td>
                        <td> {$resource_name} </td>
                        <td> ------------- </td>
                        <td> {$total_allocation} % Avaialble </td>
                    </tr> 
                    ";
                }
                return $this->response_json($response);

            }

            if($availability=="Unchecked") {

                global $wpdb;
            
            $projects_resources    = $wpdb->prefix.'projects_resources';

            $quary = "SELECT * FROM $projects_resources WHERE resource_name = '{$resource_name}' and project_name = '{$project_name}'";
            $projects_resources_results = $wpdb->get_results($quary);

            if(!$projects_resources_results) {
                $quary = "SELECT * FROM $projects_resources WHERE resource_name = '{$resource_name}' or project_name = '{$project_name}'";
                $projects_resources_results = $wpdb->get_results($quary);
            }
    
            // print_r($projects_resources_results); exit;
            
            // print_r($projects_resources_results); exit;

            foreach($projects_resources_results as $key => $projects_resources_result){

                $resource_id = $projects_resources_result->resource_id;
                $resourse_name = $projects_resources_result->resource_name;
                $project_id = $projects_resources_result->project_id;
                $project_name = $projects_resources_result->project_name;
                $allocation = $projects_resources_result->allocation;
                
                $response['table'] .= "
            
                <tr>
                    <td> {$resource_id} </td>
                    <td> {$resourse_name} </td>
                    <td> {$project_name} </td>
                    <td> {$allocation} </td>
                </tr> 
                ";
            }	       
            return $this->response_json($response);

            }    
          
          }      
    }
}
$RM_Main = new RM_Main();